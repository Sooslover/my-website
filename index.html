<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 
    <title>Prompt & Speech Assistant</title>
    <style>
        /* Professional styling improvements */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: start;
            height: 100%;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        h1, h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        h1 {
            margin-top: 20px;
            font-size: 2.2rem;
            letter-spacing: -0.5px;
        }
        
        h3 {
            font-size: 1.3rem;
            color: #34495e;
        }

        button, select, input[type="checkbox"] {
            padding: 10px 20px;
            margin: 5px 5px 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button {
            background-color: #3498db;
            color: white;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        select {
            background-color: #fff;
            border: 1px solid #ddd;
            color: #333;
            padding: 9px 15px;
        }
        
        select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }

        #toggle-theme-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            background-color: #555;
            color: white;
            padding: 8px 12px;
            border-radius: 25px;
            font-size: 0.85rem;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        #quick-guide {
            margin-bottom: 20px;
            text-align: center;
        }
        
        #guide-content {
            text-align: left;
            border-left: 3px solid #3498db;
            padding-left: 15px;
        }
        
        #guide-content p {
            margin: 8px 0;
        }
        
        #guide-content kbd {
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 1px rgba(0,0,0,.2);
            color: #333;
            display: inline-block;
            font-size: 0.85rem;
            font-weight: 700;
            line-height: 1;
            padding: 3px 6px;
            white-space: nowrap;
        }

        /* Improved layout */
        #two-column-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
        }

        #left-column, #right-column {
            flex: 1;
            min-width: 300px;
            max-width: calc(50% - 12.5px);
            transition: all 0.3s ease;
        }
        
        /* Card-like designs */
        #promptContainer, #output, #timer, #settings-panel, #history-list li {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        #promptContainer:hover, #output:hover {
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }
        
        /* Controls styling */
        #controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin: 0 0 15px 0;
            gap: 8px;
        }
        
        #controls button {
            flex: 1;
            min-width: 80px;
            max-width: 150px;
            padding: 10px 16px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-radius: 6px;
        }
        
        /* Button variations */
        #start-btn {
            background-color: #27ae60;
        }
        #start-btn:hover {
            background-color: #219653;
        }
        
        #stop-btn {
            background-color: #e74c3c;
        }
        #stop-btn:hover {
            background-color: #c0392b;
        }
        
        #pause-resume-btn {
            background-color: #f39c12;
        }
        #pause-resume-btn:hover {
            background-color: #d35400;
        }
        
        #tts-btn {
            background-color: #9b59b6;
        }
        #tts-btn:hover {
            background-color: #8e44ad;
        }
        
        /* Disabled state */
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        #output {
            width: 100%;
            height: 250px;
            margin-top: 15px;
            padding: 16px;
            font-size: 16px;
            line-height: 1.6;
            overflow-y: auto;
            background: white;
            transition: background-color 0.3s, color 0.3s;
            border: none;
        }

        #timer {
            font-size: 1.1rem;
            margin-top: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            text-align: center;
            font-weight: 500;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        #timer::before {
            content: "‚è±";
            font-size: 1.2rem;
        }

        #status-indicator {
            display: none;
            color: #e74c3c;
            font-weight: bold;
            margin-top: 10px;
            padding: 8px 12px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 20px;
            text-align: center;
            width: fit-content;
            margin: 10px auto;
        }

        #status-indicator.active {
            display: block;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 25px;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-size: 1rem;
            font-weight: 500;
            opacity: 0;
            animation: fadeInOut 2s forwards;
            z-index: 1000;
            text-align: center;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            15% { opacity: 1; transform: translate(-50%, -50%); }
            85% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }

        #word-count {
            margin-top: 15px;
            font-size: 0.95rem;
            color: #7f8c8d;
            text-align: right;
            padding: 0 5px;
        }

        /* Prompt container styling */
        #promptContainer {
            background-color: #ffffff;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: calc(100% - 40px);
        }
        
        #promptContainer h2 {
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
            color: #2c3e50;
            position: relative;
            padding-bottom: 12px;
        }
        
        #promptContainer h2::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: #3498db;
            border-radius: 3px;
        }
        
        #promptContainer .section {
            margin-bottom: 16px;
        }
        
        #promptContainer label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.95rem;
            color: #34495e;
        }
        
        #promptContainer textarea, 
        #promptContainer select {
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 14px;
            padding: 10px 12px;
            resize: vertical;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            background-color: #f9f9f9;
            transition: all 0.3s;
            min-height: 38px;
        }
        
        #template-select {
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 14px;
            padding: 10px 12px;
            resize: vertical;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            background-color: #f9f9f9;
            transition: all 0.3s;
            min-height: 38px;
        }
        
        #template-select optgroup {
            font-weight: bold;
            font-style: normal;
            color: #2c3e50;
            background-color: #f1f1f1;
        }
        
        #template-select option {
            padding: 8px 4px;
        }
        
        .dark-mode #template-select optgroup {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        
        #promptContainer textarea:focus,
        #promptContainer select:focus {
            outline: none;
            border-color: #3498db;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }
        
        #promptContainer select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23131313%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 12px auto;
            padding-right: 30px;
        }
        
        #promptContainer .button-container {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 15px;
        }
        
        #promptContainer .button-container button {
            flex: 1;
            padding: 10px 16px;
            font-weight: 600;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
            min-width: 100px;
            border-radius: 6px;
        }
        
        #generateBtn {
            background-color: #2ecc71;
        }
        
        #generateBtn:hover {
            background-color: #27ae60;
        }
        
        #clearBtn {
            background-color: #e74c3c;
        }
        
        #clearBtn:hover {
            background-color: #c0392b;
        }
        
        #promptContainer textarea#finalPrompt {
            margin-top: 12px;
            min-height: 100px;
            font-family: 'Consolas', 'Courier New', monospace;
            background-color: #f8f9fa;
            border: 1px solid #e1e1e1;
            padding: 12px;
            line-height: 1.5;
            color: #2c3e50;
        }
        
        #promptContainer #copySuccess {
            display: none;
            margin-top: 8px;
            color: #27ae60;
            font-weight: 600;
            text-align: center;
            padding: 6px;
            background-color: rgba(46, 204, 113, 0.1);
            border-radius: 4px;
        }

        #settings-panel, #history {
            padding: 16px;
            background: white;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        #settings-panel h3, #history h3 {
            margin-top: 0;
            margin-bottom: 16px;
            text-align: left;
            display: flex;
            align-items: center;
            font-size: 1.2rem;
        }
        
        #settings-panel h3::before {
            content: "‚öôÔ∏è";
            margin-right: 8px;
            font-size: 1.2rem;
        }
        
        #history h3::before {
            content: "üìú";
            margin-right: 8px;
            font-size: 1.2rem;
        }

        #history-list {
            list-style-type: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        #history-list li {
            margin-bottom: 10px;
            background: #f8f9fa;
            padding: 12px;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.5;
            transition: all 0.2s;
        }
        
        #history-list li:hover {
            background: #f1f1f1;
        }

        #history-list li button {
            margin: 5px 2px;
            padding: 6px 12px;
            font-size: 0.8rem;
            background-color: transparent;
            color: #3498db;
            border: 1px solid #3498db;
            box-shadow: none;
        }
        
        #history-list li button:hover {
            background-color: #3498db;
            color: white;
        }
        
        #history-list li button:last-child {
            color: #e74c3c;
            border-color: #e74c3c;
        }
        
        #history-list li button:last-child:hover {
            background-color: #e74c3c;
            color: white;
        }

        #history-search {
            width: 70%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            background-color: #f8f9fa;
            transition: all 0.3s;
        }
        
        #history-search:focus {
            outline: none;
            border-color: #3498db;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }
        
        #clear-history-btn {
            background-color: #e74c3c;
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        /* Settings styling */
        #settings-panel label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95rem;
            cursor: pointer;
        }
        
        #settings-panel input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        #language-select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            background-color: #f8f9fa;
            margin-bottom: 15px;
            width: 100%;
            max-width: 200px;
        }

        /* Dark mode improvements */
        .dark-mode {
            background: #1a202c;
            color: #e2e8f0;
        }

        .dark-mode h1, 
        .dark-mode h3, 
        .dark-mode p, 
        .dark-mode label {
            color: #e2e8f0;
        }
        
        .dark-mode #promptContainer h2,
        .dark-mode #promptContainer label {
            color: #e2e8f0;
        }
        
        .dark-mode #promptContainer h2::after {
            background-color: #3498db;
        }

        .dark-mode #output,
        .dark-mode #promptContainer,
        .dark-mode #settings-panel,
        .dark-mode #history {
            background: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        
        .dark-mode #promptContainer textarea,
        .dark-mode #promptContainer select,
        .dark-mode #history-search,
        .dark-mode #language-select {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #2d3748;
        }
        
        .dark-mode #promptContainer textarea::placeholder,
        .dark-mode #history-search::placeholder {
            color: #a0aec0;
        }
        
        .dark-mode #promptContainer textarea#finalPrompt {
            background-color: #4a5568;
            border-color: #2d3748;
            color: #e2e8f0;
        }

        .dark-mode #timer {
            background: #2d3748;
            color: #e2e8f0;
        }
        
        .dark-mode #word-count {
            color: #a0aec0;
        }

        .dark-mode #history-list li {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #2d3748;
        }
        
        .dark-mode #history-list li:hover {
            background: #3a4257;
        }
        
        .dark-mode #history-list li button {
            background-color: transparent;
            color: #63b3ed;
            border-color: #63b3ed;
        }
        
        .dark-mode #history-list li button:hover {
            background-color: #4299e1;
            color: #e2e8f0;
        }
        
        .dark-mode #history-list li button:last-child {
            color: #fc8181;
            border-color: #fc8181;
        }
        
        .dark-mode #history-list li button:last-child:hover {
            background-color: #f56565;
            color: #e2e8f0;
        }
        
        .dark-mode #toggle-theme-btn {
            background-color: #718096;
        }

        .dark-mode .popup {
            background-color: rgba(255, 255, 255, 0.15);
            color: #e2e8f0;
        }
        
        .dark-mode #promptContainer #copySuccess {
            color: #68d391;
            background-color: rgba(104, 211, 145, 0.1);
        }
        
        .dark-mode #guide-content {
            border-left-color: #4299e1;
        }
        
        .dark-mode #guide-content kbd {
            background-color: #4a5568;
            border-color: #2d3748;
            color: #e2e8f0;
            box-shadow: 0 1px 1px rgba(0,0,0,.4);
        }
        
        /* Animation for theme transition */
        body, #output, #promptContainer, #settings-panel, #history, 
        #timer, .dark-mode #output, .dark-mode #promptContainer, 
        .dark-mode #settings-panel, .dark-mode #history, .dark-mode #timer {
            transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }
        
        /* Adjust for mobile */
        @media (max-width: 768px) {
            #left-column, #right-column {
                max-width: 100%;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            #controls button {
                font-size: 0.85rem;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Include jsPDF from CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- THEME TOGGLE BUTTON -->
    <button id="toggle-theme-btn"><i class="fas fa-moon"></i></button>

    <h1 id="main-heading">Prompt & Speech Assistant</h1>
    
    <!-- Quick guide -->
    <div id="quick-guide">
        <span id="toggle-guide" style="cursor:pointer; text-decoration:underline; color:#3498db; font-size:0.9rem;">How to use</span>
        <div id="guide-content" style="display:none; margin-top:10px; padding:15px; background:#f8f9fa; border-radius:8px; max-width:800px; font-size:0.95rem;">
            <p><strong>Left Panel:</strong> Create structured AI prompts by filling in the template fields.</p>
            <p><strong>Right Panel:</strong> Convert your speech to text in real-time, edit, and save the results.</p>
            <p><strong>Keyboard Shortcuts:</strong> 
                <kbd>Ctrl+B</kbd> Start/Stop Recording | 
                <kbd>Ctrl+P</kbd> Pause/Resume | 
                <kbd>Ctrl+S</kbd> Save Text | 
                <kbd>Ctrl+G</kbd> Generate Prompt
            </p>
        </div>
    </div>

    <!-- TWO-COLUMN LAYOUT -->
    <div id="two-column-layout">

        <!-- LEFT COLUMN: Prompt Template Generator -->
        <div id="left-column">
            <div id="promptContainer">
                <h2>Prompt Template Generator</h2>

                <!-- Quick Templates Dropdown -->
                <div class="section">
                    <label for="template-select">Academic Templates:</label>
                    <select id="template-select" style="width: 100%; padding: 10px; border-radius: 6px;">
                        <option value="">Select a template...</option>
                        
                        <!-- Research & Writing Templates -->
                        <optgroup label="Research & Writing">
                            <option value="academic">General Academic Writing</option>
                            <option value="research_proposal">Research Proposal</option>
                            <option value="literature_review">Literature Review</option>
                            <option value="thesis">Thesis Development</option>
                            <option value="academic_critique">Academic Critique</option>
                            <option value="essay_structure">Essay Structure</option>
                            <option value="annotated_bibliography">Annotated Bibliography</option>
                            <option value="case_study">Case Study Analysis</option>
                            <option value="argumentative_essay">Argumentative Essay</option>
                            <option value="comparative_analysis">Comparative Analysis</option>
                        </optgroup>
                        
                        <!-- Scientific & Technical -->
                        <optgroup label="Scientific & Technical">
                            <option value="scientific_abstract">Scientific Abstract</option>
                            <option value="methodology">Research Methodology</option>
                            <option value="lab_report">Lab Report Structure</option>
                            <option value="statistical_analysis">Statistical Analysis</option>
                            <option value="research_ethics">Research Ethics Proposal</option>
                            <option value="technical_report">Technical Report</option>
                        </optgroup>
                        
                        <!-- Publication & Presentation -->
                        <optgroup label="Publication & Presentation">
                            <option value="journal_article">Journal Article Structure</option>
                            <option value="conference_presentation">Conference Presentation</option>
                            <option value="research_poster">Research Poster Design</option>
                            <option value="book_chapter">Academic Book Chapter</option>
                            <option value="book_review">Academic Book Review</option>
                            <option value="peer_review">Peer Review</option>
                        </optgroup>
                        
                        <!-- Teaching & Educational -->
                        <optgroup label="Teaching & Educational">
                            <option value="course_syllabus">Course Syllabus</option>
                            <option value="lecture_plan">Lecture Plan</option>
                            <option value="teaching_materials">Teaching Materials</option>
                            <option value="student_feedback">Student Feedback</option>
                            <option value="educational_assessment">Educational Assessment</option>
                        </optgroup>
                        
                        <!-- Academic Career -->
                        <optgroup label="Academic Career">
                            <option value="grant">Grant Application</option>
                            <option value="dissertation_defense">Dissertation Defense</option>
                            <option value="academic_cv">Academic CV</option>
                            <option value="research_statement">Research Statement</option>
                            <option value="tenure_application">Tenure Application</option>
                        </optgroup>
                        
                        <!-- Support & Resources -->
                        <optgroup label="Support & Resources">
                            <option value="citation">Citation Helper</option>
                            <option value="plagiarism_prevention">Plagiarism Prevention</option>
                            <option value="scholarly_sources">Scholarly Source Evaluation</option>
                            <option value="academic_integrity">Academic Integrity Guide</option>
                        </optgroup>
                        
                        <option value="custom">Custom Academic Template</option>
                    </select>
                </div>

                <!-- 1) "You are a" -->
                <div class="section">
                    <label for="roleContext">You are a:</label>
                    <textarea id="roleContext" rows="1" placeholder="e.g., marketing expert with 10 years experience"></textarea>
                </div>

                <!-- 2) "Your task is to" -->
                <div class="section">
                    <label for="objective">Your task is to:</label>
                    <textarea id="objective" rows="1" placeholder="e.g., create engaging social media content for my product"></textarea>
                </div>

                <!-- 3) "Provide" -->
                <div class="section">
                    <label for="detailedInstructions">Provide:</label>
                    <textarea id="detailedInstructions" rows="2" placeholder="e.g., clear, punchy headlines that drive engagement and incorporate the latest trends"></textarea>
                </div>

                <!-- 4) Background/Context -->
                <div class="section">
                    <label for="backgroundContext">Background/Context:</label>
                    <textarea id="backgroundContext" rows="2" placeholder="e.g., Our product is a sustainable water bottle targeting health-conscious millennials"></textarea>
                </div>

                <!-- 5) "Present your answer" -->
                <div class="section">
                    <label for="outputFormat">Present your answer:</label>
                    <textarea id="outputFormat" rows="1" placeholder="e.g., in a numbered list with 5 options, including rationale for each"></textarea>
                </div>

                <!-- Buttons and output -->
                <div class="button-container">
                    <button id="generateBtn"><i class="fas fa-bolt"></i> Generate & Copy</button>
                    <button id="clearBtn"><i class="fas fa-trash"></i> Clear All</button>
                </div>
                <textarea id="finalPrompt" readonly></textarea>
                <div id="copySuccess">Copied to clipboard!</div>
                
                <!-- Speech to Prompt Button -->
                <div style="margin-top: 15px; text-align: center;">
                    <button id="speech-to-prompt-btn" style="background-color: #9b59b6; width: 100%;">
                        <i class="fas fa-magic"></i> Convert Speech to Prompt
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Enhanced Speech to Text Converter -->
        <div id="right-column">
            <!-- Controls with icons -->
            <div id="controls">
                <button id="start-btn"><i class="fas fa-microphone"></i> Start</button>
                <button id="stop-btn" disabled><i class="fas fa-stop"></i> Stop</button>
                <button id="pause-resume-btn"><i class="fas fa-pause"></i> Pause</button>
                <button id="save-btn"><i class="fas fa-download"></i> Save</button>
                <button id="pdf-btn"><i class="fas fa-file-pdf"></i> PDF</button>
                <button id="tts-btn"><i class="fas fa-volume-up"></i> Play</button>
            </div>

            <!-- Output area -->
            <div id="output" contenteditable="true" spellcheck="true"></div>
            <div id="timer">00:00:00</div>
            <div id="status-indicator">‚óè  Recording</div>
            <div id="word-count">Words: 0</div>

            <!-- Settings panel -->
            <div id="settings-panel">
                <h3>Settings</h3>
                <div>
                    <label for="language-select">Recognition Language:</label>
                    <select id="language-select">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="fr-FR">French (FR)</option>
                        <option value="de-DE">German (DE)</option>
                        <option value="es-ES">Spanish (ES)</option>
                        <option value="it-IT">Italian (IT)</option>
                        <option value="pt-BR">Portuguese (BR)</option>
                        <option value="zh-CN">Chinese (Simplified)</option>
                        <option value="ja-JP">Japanese (JP)</option>
                        <option value="ko-KR">Korean (KR)</option>
                        <option value="hi-IN">Hindi (IN)</option>
                        <option value="ar-SA">Arabic (SA)</option>
                    </select>
                </div>
                
                <div style="margin-top: 15px;">
                    <label><input type="checkbox" id="interim-checkbox" /> Show interim results</label>
                    <label><input type="checkbox" id="continuous-checkbox" checked/> Continuous recognition</label>
                    <label><input type="checkbox" id="auto-punctuate" checked/> Auto-punctuation</label>
                </div>
            </div>

            <!-- History -->
            <div id="history">
                <h3>Transcription History</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="history-search" placeholder="Search history..." />
                    <button id="clear-history-btn"><i class="fas fa-trash-alt"></i> Clear</button>
                </div>
                <ul id="history-list"></ul>
            </div>
        </div>
    </div>

    <!-- =============== SCRIPTS =============== -->
    <script>
    /************* PROMPT TEMPLATE GENERATOR LOGIC *************/
    // Templates for quick selection
    const promptTemplates = {
        // Research & Writing Templates
        academic: {
            role: "academic researcher with expertise in scholarly writing and citation standards",
            task: "help me develop well-structured academic content on my chosen topic",
            instructions: "thorough, evidence-based analysis that adheres to academic standards and incorporates relevant literature",
            background: "",
            format: "following proper academic structure with clear arguments, supporting evidence, and proper citations"
        },
        research_proposal: {
            role: "research methodology expert with experience in grant writing and proposal development",
            task: "help me craft a compelling research proposal for my academic project",
            instructions: "a structured proposal with clear research questions, objectives, theoretical framework, and significance of the study",
            background: "",
            format: "following standard academic proposal format with sections for introduction, literature review, methodology, expected outcomes, timeline, and references"
        },
        literature_review: {
            role: "academic researcher with extensive experience in literature analysis and synthesis",
            task: "help me organize and analyze existing literature on my research topic",
            instructions: "a comprehensive literature review that identifies patterns, gaps, and relationships among existing studies",
            background: "",
            format: "with thematic organization rather than chronological listing, highlighting theoretical frameworks and methodological approaches relevant to my research"
        },
        thesis: {
            role: "dissertation advisor with expertise in thesis development and academic argumentation",
            task: "help me develop and refine a strong thesis statement or dissertation framework",
            instructions: "a clear, focused, and defensible thesis statement that establishes the significance of my research question",
            background: "",
            format: "with supporting sub-arguments, potential counterarguments, and a roadmap for developing the larger work"
        },
        academic_critique: {
            role: "academic reviewer with expertise in critical analysis of scholarly works",
            task: "help me develop a rigorous critique of an academic text or theory",
            instructions: "a balanced critical analysis that evaluates strengths, weaknesses, assumptions, and implications",
            background: "",
            format: "with evaluation of methodology, theoretical framework, evidence quality, logic of argumentation, and significance to the field"
        },
        essay_structure: {
            role: "academic writing instructor with expertise in rhetorical structure and argumentation",
            task: "help me plan the structure of my academic essay or paper",
            instructions: "a logical framework that effectively develops my arguments and supports my thesis",
            background: "",
            format: "with section outlines, transition strategies, and guidance for incorporating evidence and counter-arguments"
        },
        annotated_bibliography: {
            role: "academic librarian specialized in research methodology and bibliographic analysis",
            task: "help me create an annotated bibliography for my research topic",
            instructions: "comprehensive annotations that summarize, evaluate, and reflect on each source's relevance to my research",
            background: "",
            format: "following proper citation style with annotations that address the source's purpose, methodology, key findings, limitations, and value to my research"
        },
        case_study: {
            role: "qualitative researcher with expertise in case study methodology across disciplines",
            task: "help me develop an analytical case study for academic purposes",
            instructions: "a detailed, rigorous case study that connects empirical observations with theoretical frameworks",
            background: "",
            format: "with clear case selection rationale, contextual background, methodological approach, findings analysis, implications, and limitations"
        },
        argumentative_essay: {
            role: "rhetoric professor with expertise in logical argumentation and persuasive academic writing",
            task: "help me develop a strong argumentative essay on my chosen topic",
            instructions: "a well-reasoned argument supported by scholarly evidence and addressing counterarguments",
            background: "",
            format: "structured with a clear thesis, supporting arguments, counterargument acknowledgment, rebuttals, and a compelling conclusion"
        },
        comparative_analysis: {
            role: "comparative research expert with experience in cross-disciplinary analytical frameworks",
            task: "help me conduct a scholarly comparison between two or more subjects",
            instructions: "a systematic comparative analysis identifying similarities, differences, and relationships",
            background: "",
            format: "using appropriate comparative methodology with clear comparison criteria, balanced analysis, and significant implications"
        },
        
        // Scientific & Technical Templates
        scientific_abstract: {
            role: "scientific journal editor with expertise in abstract writing and academic publishing",
            task: "help me craft a concise and effective abstract for my scientific paper",
            instructions: "a comprehensive yet compact abstract that accurately represents my research",
            background: "",
            format: "following the standard structure: background, objectives, methods, results, and conclusions within a strict word limit"
        },
        methodology: {
            role: "research methods specialist with expertise in qualitative and quantitative approaches",
            task: "help me develop and describe the methodology section of my research",
            instructions: "a detailed methodology description that justifies my research design choices",
            background: "",
            format: "including research approach, data collection methods, analytical techniques, ethical considerations, and limitations"
        },
        lab_report: {
            role: "laboratory science instructor with expertise in scientific report writing",
            task: "help me structure and write a comprehensive lab report",
            instructions: "a clear, detailed lab report following scientific conventions",
            background: "",
            format: "with standard sections: title, abstract, introduction, methods, results, discussion, conclusion, and references, with appropriate data presentation"
        },
        statistical_analysis: {
            role: "statistician with expertise in research design and data analysis for academic studies",
            task: "help me plan or interpret the statistical analysis for my research",
            instructions: "clear guidance on appropriate statistical methods, interpretation of results, and discussion of implications",
            background: "",
            format: "including explanation of statistical concepts, choice of tests, assumptions, limitations, and proper reporting format"
        },
        research_ethics: {
            role: "research ethics committee member with expertise in ethical frameworks across disciplines",
            task: "help me develop an ethics proposal or address ethical considerations in my research",
            instructions: "a comprehensive assessment of ethical implications and appropriate protocols",
            background: "",
            format: "addressing informed consent, confidentiality, risk assessment, vulnerable populations, data handling, and researcher positionality"
        },
        technical_report: {
            role: "technical writing specialist with expertise in scientific and engineering documentation",
            task: "help me structure and write a technical report for my academic project",
            instructions: "a clear, precise technical report that effectively communicates complex information",
            background: "",
            format: "with appropriate sections, terminology, data visualization, technical specificity, and audience consideration"
        },
        
        // Publication & Presentation Templates
        journal_article: {
            role: "academic publishing consultant with experience in scholarly journal requirements",
            task: "help me structure and develop a journal article based on my research",
            instructions: "a well-structured manuscript that meets academic publishing standards",
            background: "",
            format: "following IMRAD or appropriate structure with attention to journal-specific requirements, contribution claims, and scholarly dialogue"
        },
        conference_presentation: {
            role: "academic presentation coach with expertise in scholarly conference communications",
            task: "help me prepare an effective conference presentation of my research",
            instructions: "a clear, engaging presentation that effectively communicates my research to an academic audience",
            background: "",
            format: "structured for the allocated time with appropriate visual aids, key points emphasis, anticipated questions, and scholarly context"
        },
        research_poster: {
            role: "academic visual communication specialist with expertise in research poster design",
            task: "help me design an effective academic poster presentation",
            instructions: "a visually compelling and informationally concise research poster",
            background: "",
            format: "with optimal layout, visual hierarchy, graphic elements, concise text, and appropriate data visualization for academic conference standards"
        },
        book_chapter: {
            role: "academic editor with expertise in scholarly book production and chapter development",
            task: "help me structure and write a chapter for an academic book",
            instructions: "a coherent, substantial chapter that contributes to the book's overall theme while maintaining standalone value",
            background: "",
            format: "with appropriate scholarly depth, integration with the book's framework, thorough referencing, and attention to editor requirements"
        },
        book_review: {
            role: "literary critic with expertise in academic book review conventions",
            task: "help me write a scholarly book review for an academic publication",
            instructions: "a critical, analytical review that evaluates the book's contribution to its field",
            background: "",
            format: "addressing the book's purpose, theoretical framework, methodological approach, evidence quality, argumentation, significance, and limitations"
        },
        peer_review: {
            role: "academic journal reviewer with expertise in scholarly peer review processes",
            task: "help me construct a thorough peer review for an academic manuscript",
            instructions: "a constructive and comprehensive review that evaluates the manuscript's strengths and weaknesses",
            background: "",
            format: "addressing key aspects: contribution to the field, methodological rigor, theoretical framing, clarity of presentation, and recommendations for improvement"
        },
        
        // Teaching & Educational Templates
        course_syllabus: {
            role: "curriculum design specialist with expertise in higher education pedagogy",
            task: "help me develop a comprehensive syllabus for an academic course",
            instructions: "a well-structured syllabus that effectively communicates course objectives, content, and expectations",
            background: "",
            format: "including course description, learning outcomes, schedule, assignments, assessment criteria, policies, and resources aligned with educational standards"
        },
        lecture_plan: {
            role: "instructional designer with expertise in higher education teaching methodologies",
            task: "help me create an effective lecture plan for an academic session",
            instructions: "a structured lecture plan that facilitates learning through engagement and clear knowledge transmission",
            background: "",
            format: "with clear learning objectives, content sequence, engagement strategies, visual aids, discussion questions, and assessment components"
        },
        teaching_materials: {
            role: "educational content developer with expertise in academic resource creation",
            task: "help me develop effective teaching materials for my course",
            instructions: "pedagogically sound materials that support student learning and engagement",
            background: "",
            format: "with clear instructional purpose, accessibility considerations, scaffolded complexity, and support for diverse learning approaches"
        },
        student_feedback: {
            role: "educational assessment specialist with expertise in constructive feedback approaches",
            task: "help me provide effective feedback on student academic work",
            instructions: "constructive, specific feedback that facilitates student improvement and engagement",
            background: "",
            format: "balancing strengths and areas for improvement, specific examples, clear expectations, and actionable suggestions"
        },
        educational_assessment: {
            role: "academic assessment expert with experience in educational evaluation methods",
            task: "help me develop appropriate assessment methods for academic learning",
            instructions: "valid, reliable assessment strategies that align with learning objectives",
            background: "",
            format: "with clear criteria, rubrics, diverse assessment types, formative and summative approaches, and academic integrity considerations"
        },
        
        // Academic Career Templates
        grant: {
            role: "grant writing specialist with experience in academic funding applications",
            task: "help me craft a compelling grant application for my research project",
            instructions: "a persuasive proposal that clearly communicates the significance, innovation, and feasibility of my research",
            background: "",
            format: "addressing all key components: project summary, objectives, significance, innovation, approach, budget justification, and broader impacts"
        },
        dissertation_defense: {
            role: "doctoral committee advisor with expertise in dissertation defense preparation",
            task: "help me prepare for my dissertation defense",
            instructions: "effective preparation strategies and response frameworks for the defense examination",
            background: "",
            format: "including presentation structure, anticipated questions, research justification approaches, and scholarly dialogue techniques"
        },
        academic_cv: {
            role: "academic career advisor with expertise in scholarly CV development",
            task: "help me create or improve my academic curriculum vitae",
            instructions: "a comprehensive, properly formatted academic CV that effectively represents my scholarly accomplishments",
            background: "",
            format: "with appropriate sections, emphasis on research, teaching, service contributions, and adherence to academic conventions"
        },
        research_statement: {
            role: "academic career consultant specialized in research narrative development",
            task: "help me craft a compelling research statement for academic applications",
            instructions: "a clear, focused research statement that articulates my scholarly identity and agenda",
            background: "",
            format: "addressing past accomplishments, current projects, future directions, theoretical frameworks, methodological approaches, and significance to the field"
        },
        tenure_application: {
            role: "academic promotion specialist with expertise in tenure review processes",
            task: "help me prepare effective materials for my tenure application",
            instructions: "compelling documentation that demonstrates my qualifications for tenure",
            background: "",
            format: "highlighting scholarly impact, research trajectory, teaching effectiveness, service contributions, and alignment with institutional values"
        },
        
        // Support & Resources Templates
        citation: {
            role: "academic librarian with expertise in citation styles and reference management",
            task: "help me properly format citations and references for my academic work",
            instructions: "guidance on correctly formatting in-text citations and bibliography entries",
            background: "",
            format: "according to the specific style guide I'm using (APA, MLA, Chicago, etc.) with examples for different source types"
        },
        plagiarism_prevention: {
            role: "academic integrity officer with expertise in plagiarism identification and prevention",
            task: "help me understand and avoid plagiarism in my academic writing",
            instructions: "clear guidance on ethical citation practices and original contribution",
            background: "",
            format: "addressing different types of plagiarism, proper paraphrasing, quotation techniques, citation practices, and originality verification"
        },
        scholarly_sources: {
            role: "research librarian with expertise in scholarly source evaluation",
            task: "help me find and evaluate appropriate scholarly sources for my research",
            instructions: "strategies for locating and critically assessing academic sources",
            background: "",
            format: "including database search techniques, source credibility criteria, disciplinary considerations, and integration approaches"
        },
        academic_integrity: {
            role: "research ethics educator with expertise in academic integrity principles",
            task: "help me understand and adhere to academic integrity standards in my work",
            instructions: "comprehensive guidance on ethical academic practices",
            background: "",
            format: "addressing citation practices, collaboration boundaries, data integrity, research ethics, and institutional policy compliance"
        },
        
        // Keep custom template for flexibility
        custom: {
            role: "",
            task: "",
            instructions: "",
            background: "",
            format: ""
        }
    };
    
    // Load template when selected
    document.getElementById("template-select").addEventListener("change", function() {
        const templateKey = this.value;
        if (templateKey && promptTemplates[templateKey]) {
            const template = promptTemplates[templateKey];
            document.getElementById("roleContext").value = template.role;
            document.getElementById("objective").value = template.task;
            document.getElementById("detailedInstructions").value = template.instructions;
            document.getElementById("backgroundContext").value = template.background;
            document.getElementById("outputFormat").value = template.format;
        }
    });
    
    function generateAndCopyPrompt(copyToClipboard = true) {
      // Retrieve the content of each field
      const roleContext = document.getElementById("roleContext").value.trim();
      const objective = document.getElementById("objective").value.trim();
      const detailedInstructions = document.getElementById("detailedInstructions").value.trim();
      const backgroundContext = document.getElementById("backgroundContext").value.trim();
      const outputFormat = document.getElementById("outputFormat").value.trim();

      // Build the final prompt, including each phrase only if the field is filled
      let finalPromptText = "";

      if (roleContext) {
        finalPromptText += `You are a ${roleContext}\n\n`;
      }
      if (objective) {
        finalPromptText += `Your task is to ${objective}\n\n`;
      }
      if (detailedInstructions) {
        finalPromptText += `Provide ${detailedInstructions}\n\n`;
      }
      if (backgroundContext) {
        finalPromptText += `Background/Context:\n${backgroundContext}\n\n`;
      }
      if (outputFormat) {
        finalPromptText += `Present your answer ${outputFormat}\n\n`;
      }

      // Trim extra spaces/newlines
      finalPromptText = finalPromptText.trim();

      // Place the result in the finalPrompt textarea
      const finalPromptArea = document.getElementById("finalPrompt");
      finalPromptArea.value = finalPromptText;

      // Copy to clipboard if requested
      if (copyToClipboard) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(finalPromptText)
            .then(() => showCopySuccess())
            .catch(err => console.error("Error copying:", err));
        } else {
          // Fallback for older browsers
          finalPromptArea.select();
          document.execCommand("copy");
          showCopySuccess();
        }
      }
      
      // Save to local storage for future use
      saveCustomTemplate();
    }

    // Show a transient "copied" message for one second
    function showCopySuccess() {
      const copySuccessDiv = document.getElementById("copySuccess");
      copySuccessDiv.style.display = "block";
      setTimeout(() => {
        copySuccessDiv.style.display = "none";
      }, 1500);
    }

    // Clear all text fields and the final prompt area
    function clearAllFields() {
      document.getElementById("roleContext").value = "";
      document.getElementById("objective").value = "";
      document.getElementById("detailedInstructions").value = "";
      document.getElementById("backgroundContext").value = "";
      document.getElementById("outputFormat").value = "";
      document.getElementById("finalPrompt").value = "";
      document.getElementById("copySuccess").style.display = "none";
    }
    
    // Save the custom template
    function saveCustomTemplate() {
      const template = {
        role: document.getElementById("roleContext").value.trim(),
        task: document.getElementById("objective").value.trim(),
        instructions: document.getElementById("detailedInstructions").value.trim(),
        background: document.getElementById("backgroundContext").value.trim(),
        format: document.getElementById("outputFormat").value.trim()
      };
      
      if (template.role || template.task || template.instructions || template.background || template.format) {
        localStorage.setItem('customPromptTemplate', JSON.stringify(template));
      }
    }

    /************* ENHANCED SPEECH-TO-TEXT CONVERTER LOGIC *************/
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const pauseResumeBtn = document.getElementById('pause-resume-btn');
    const saveBtn = document.getElementById('save-btn');
    const pdfBtn = document.getElementById('pdf-btn');
    const ttsBtn = document.getElementById('tts-btn');
    const output = document.getElementById('output');
    const timerDisplay = document.getElementById('timer');
    const statusIndicator = document.getElementById('status-indicator');
    const wordCountDisplay = document.getElementById('word-count');
    const historyList = document.getElementById('history-list');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const historySearch = document.getElementById('history-search');
    const toggleThemeBtn = document.getElementById('toggle-theme-btn');
    const mainHeading = document.getElementById('main-heading');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');

    const languageSelect = document.getElementById('language-select');
    const interimCheckbox = document.getElementById('interim-checkbox');
    const continuousCheckbox = document.getElementById('continuous-checkbox');
    const autoPunctuateCheckbox = document.getElementById('auto-punctuate');

    let timerInterval;
    let startTime;
    let speechBuffer = '';
    let isPaused = false;
    let currentLanguage = languageSelect.value;
    let useInterim = interimCheckbox.checked;
    let useContinuous = continuousCheckbox.checked;
    let autoPunctuate = autoPunctuateCheckbox.checked;
    let darkMode = false;

    // Add event listeners for prompt generator buttons
    generateBtn.addEventListener('click', function() { generateAndCopyPrompt(true); });
    clearBtn.addEventListener('click', clearAllFields);
    
    // Add Speech to Prompt functionality
    document.getElementById('speech-to-prompt-btn').addEventListener('click', function() {
        const transcribedText = output.textContent.trim();
        if (!transcribedText) {
            showPopup('No transcription text to convert');
            return;
        }
        
        // Simple parsing attempt
        try {
            // Extract potential role
            let role = '';
            if (transcribedText.toLowerCase().includes('as a') || transcribedText.toLowerCase().includes('as an')) {
                const roleMatch = transcribedText.match(/as (a|an) ([^,\.]+)/i);
                if (roleMatch && roleMatch[2]) {
                    role = roleMatch[2].trim();
                }
            }
            
            // Extract potential task
            let task = '';
            if (transcribedText.toLowerCase().includes('i need') || 
                transcribedText.toLowerCase().includes('i want') ||
                transcribedText.toLowerCase().includes('please')) {
                
                const taskMatch = transcribedText.match(/(i need|i want|please) ([^\.]+)/i);
                if (taskMatch && taskMatch[2]) {
                    task = taskMatch[2].trim();
                }
            }
            
            // Fill in the form
            if (role) document.getElementById('roleContext').value = role;
            if (task) document.getElementById('objective').value = task;
            
            // Put the full text in the background/context
            document.getElementById('backgroundContext').value = transcribedText;
            
            // Generate the prompt (without copying to clipboard)
            generateAndCopyPrompt(false);
            
            // Show popup
            showPopup('Speech converted to prompt!');
            
        } catch (error) {
            console.error('Error parsing transcription:', error);
            // Still put the text in the background context
            document.getElementById('backgroundContext').value = transcribedText;
            generateAndCopyPrompt(false);
        }
    });
    
    // Load saved custom template if exists
    const savedCustomTemplate = localStorage.getItem('customPromptTemplate');
    if (savedCustomTemplate) {
        const template = JSON.parse(savedCustomTemplate);
        document.getElementById("roleContext").value = template.role || '';
        document.getElementById("objective").value = template.task || '';
        document.getElementById("detailedInstructions").value = template.instructions || '';
        document.getElementById("backgroundContext").value = template.background || '';
        document.getElementById("outputFormat").value = template.format || '';
    }
    
    // Load custom template into the dropdown
    if (savedCustomTemplate) {
        promptTemplates.custom = JSON.parse(savedCustomTemplate);
    }

    // Load history from local storage
    let historyData = JSON.parse(localStorage.getItem('transcriptionHistory')) || [];
    renderHistoryItems(historyData);
    
    // Toggle quick guide
    document.getElementById('toggle-guide').addEventListener('click', () => {
        const guideContent = document.getElementById('guide-content');
        guideContent.style.display = guideContent.style.display === 'none' ? 'block' : 'none';
    });
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+B to start/stop recording
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            if (stopBtn.disabled) {
                startRecognition();
            } else {
                stopRecognition();
            }
        }
        // Ctrl+P to pause/resume
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            if (isPaused) {
                resumeRecognition();
            } else {
                pauseRecognition();
            }
        }
        // Ctrl+S to save text
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveBtn.click();
        }
        // Ctrl+G to generate prompt
        if (e.ctrlKey && e.key === 'g') {
            e.preventDefault();
            generateBtn.click();
        }
    });

    function startTimer() {
        startTime = new Date();
        timerInterval = setInterval(() => {
            const elapsedTime = new Date(new Date() - startTime);
            const hours = String(elapsedTime.getUTCHours()).padStart(2, '0');
            const minutes = String(elapsedTime.getUTCMinutes()).padStart(2, '0');
            const seconds = String(elapsedTime.getUTCSeconds()).padStart(2, '0');
            timerDisplay.textContent = `${hours}:${minutes}:${seconds}`;
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    function updateWordCount() {
        const wordCount = speechBuffer.trim().split(/\s+/).filter(word => word).length;
        wordCountDisplay.textContent = `Words: ${wordCount}`;
    }
    
    function applyAutoPunctuation(text) {
        if (!autoPunctuateCheckbox.checked) return text;
        
        // Basic sentence capitalization
        text = text.replace(/(?:^|[.!?]\s+)([a-z])/g, (m, p1) => {
            return m.replace(p1, p1.toUpperCase());
        });
        
        // Add periods at natural pauses if missing
        text = text.replace(/\b(okay|well|so|anyway|now|then|um|uh)\s+(?=[A-Z])/gi, (m) => {
            return m.trim() + '. ';
        });
        
        return text;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = useContinuous;
        recognition.interimResults = useInterim;
        recognition.lang = currentLanguage;

        recognition.onstart = function() {
            statusIndicator.classList.add('active');
            if (!isPaused) {
                speechBuffer = output.textContent;
            }
            startTimer();
        };

        recognition.onresult = function(event) {
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                let transcript = event.results[i][0].transcript;
                
                // Apply auto-punctuation if enabled
                if (event.results[i].isFinal) {
                    if (autoPunctuateCheckbox.checked) {
                        transcript = applyAutoPunctuation(transcript);
                    } else {
                        transcript = transcript.replace(/\./g, '');
                    }
                    
                    speechBuffer += transcript + ' ';
                    output.textContent = speechBuffer;
                    updateWordCount();
                    
                    // Auto-scroll to bottom
                    output.scrollTop = output.scrollHeight;
                } else if (useInterim) {
                    let interimText = speechBuffer + transcript;
                    output.textContent = interimText;
                }
            }

            // Voice commands
            const command = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
            
            if (command === 'start' || command === 'begin recording') {
                startRecognition();
            } else if (command === 'stop' || command === 'end recording') {
                stopRecognition();
            } else if (command === 'pause') {
                pauseRecognition();
            } else if (command === 'resume') {
                resumeRecognition();
            } else if (command === 'save') {
                saveBtn.click();
            } else if (command === 'clear') {
                output.textContent = '';
                speechBuffer = '';
                updateWordCount();
            }
        };

        recognition.onerror = function(event) {
            console.error('Error occurred in recognition:', event.error);
            // If browser doesn't support the API, show a message
            if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                output.textContent = "Microphone access denied or Speech Recognition not available in this browser. For full functionality, try Chrome, Edge, or Safari.";
            }
        };

        recognition.onend = function() {
            if (!stopBtn.disabled && !isPaused) {
                if (useContinuous) {
                    recognition.start();
                }
            } else {
                stopTimer();
                
                // Try to copy to clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(output.innerText)
                        .then(() => showPopup('Text copied to clipboard!'))
                        .catch(err => console.error('Could not copy text: ', err));
                }
                
                addHistoryItem(speechBuffer.trim());
            }
            statusIndicator.classList.remove('active');
        };
    } else {
        console.error('Web Speech API is not supported in this browser.');
        output.textContent = "Speech Recognition is not supported in this browser. For full functionality, try Chrome, Edge, or Safari.";
    }

    function startRecognition() {
        if (!recognition) {
            output.textContent = "Speech Recognition is not supported in this browser. For full functionality, try Chrome, Edge, or Safari.";
            return;
        }
        stopBtn.disabled = false;
        if (!isPaused) {
            output.textContent = '';
            speechBuffer = '';
        }
        recognition.lang = currentLanguage;
        recognition.interimResults = useInterim;
        recognition.continuous = useContinuous;
        try {
            recognition.start();
            pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        } catch (error) {
            console.error('Error starting recognition:', error);
            output.textContent = "Error starting Speech Recognition. Make sure you've granted microphone permissions.";
        }
    }

    function stopRecognition() {
        if (!recognition) return;
        stopBtn.disabled = true;
        isPaused = false;
        recognition.stop();
    }

    function pauseRecognition() {
        if (!recognition) return;
        recognition.stop();
        isPaused = true;
        pauseResumeBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
        statusIndicator.classList.remove('active');
    }

    function resumeRecognition() {
        if (!recognition) return;
        recognition.start();
        isPaused = false;
        pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        statusIndicator.classList.add('active');
    }

    startBtn.addEventListener('click', startRecognition);
    stopBtn.addEventListener('click', stopRecognition);

    pauseResumeBtn.addEventListener('click', () => {
        if (isPaused) {
            resumeRecognition();
        } else {
            pauseRecognition();
        }
    });

    saveBtn.addEventListener('click', () => {
        const blob = new Blob([output.innerText], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'transcription.txt';
        link.click();
        showPopup('Saved as text file');
    });

    pdfBtn.addEventListener('click', () => {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const text = output.innerText;
            const lines = doc.splitTextToSize(text, 180);
            doc.text(lines, 10, 10);
            doc.save('transcription.pdf');
            showPopup('Saved as PDF');
        } catch (error) {
            console.error('Error generating PDF:', error);
            showPopup('Error generating PDF. Make sure the jsPDF library is loaded correctly.');
        }
    });

    ttsBtn.addEventListener('click', () => {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(output.innerText);
            speechSynthesis.speak(utterance);
            showPopup('Playing audio...');
        } else {
            showPopup('Text-to-speech is not supported in this browser.');
        }
    });

    toggleThemeBtn.addEventListener('click', () => {
        darkMode = !darkMode;
        if (darkMode) {
            document.body.classList.add('dark-mode');
            toggleThemeBtn.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            document.body.classList.remove('dark-mode');
            toggleThemeBtn.innerHTML = '<i class="fas fa-moon"></i>';
        }
    });

    function copyToClipboard(text, message) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showPopup(message);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                showPopup('Failed to copy to clipboard.');
            });
        } else {
            // Fallback method
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showPopup(message);
            } catch (err) {
                console.error('Could not copy text: ', err);
                showPopup('Failed to copy to clipboard.');
            }
            document.body.removeChild(textarea);
        }
    }

    function showPopup(text) {
        const popup = document.createElement('div');
        popup.classList.add('popup');
        popup.textContent = text;
        document.body.appendChild(popup);
        setTimeout(() => {
            document.body.removeChild(popup);
        }, 2000);
    }

    function addHistoryItem(text) {
        if (!text) return;
        historyData.push(text);
        localStorage.setItem('transcriptionHistory', JSON.stringify(historyData));
        renderHistoryItems(historyData);
    }

    function renderHistoryItems(data) {
        historyList.innerHTML = '';
        if (data.length === 0) {
            historyList.innerHTML = '<li style="text-align:center; font-style:italic; background:none; box-shadow:none;">No history items yet</li>';
            return;
        }
        
        data.forEach((item, index) => {
            const historyItem = document.createElement('li');
            historyItem.textContent = item.length > 100 ? item.substring(0, 100) + '...' : item;
            
            const copyButton = document.createElement('button');
            copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
            copyButton.addEventListener('click', () => {
                copyToClipboard(item, 'History item copied!');
            });

            const useButton = document.createElement('button');
            useButton.innerHTML = '<i class="fas fa-file-import"></i> Use';
            useButton.addEventListener('click', () => {
                output.textContent = item;
                speechBuffer = item;
                updateWordCount();
                showPopup('History item loaded');
            });

            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
            deleteButton.style.backgroundColor = 'transparent';
            deleteButton.addEventListener('click', () => {
                historyData.splice(index, 1);
                localStorage.setItem('transcriptionHistory', JSON.stringify(historyData));
                renderHistoryItems(historyData);
            });

            historyItem.appendChild(document.createElement('br'));
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '5px';
            buttonContainer.style.marginTop = '8px';
            buttonContainer.appendChild(copyButton);
            buttonContainer.appendChild(useButton);
            buttonContainer.appendChild(deleteButton);
            historyItem.appendChild(buttonContainer);
            historyList.appendChild(historyItem);
        });
    }

    clearHistoryBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear all history items?')) {
            historyData = [];
            localStorage.setItem('transcriptionHistory', JSON.stringify(historyData));
            renderHistoryItems(historyData);
            showPopup('History cleared');
        }
    });

    historySearch.addEventListener('input', () => {
        const searchTerm = historySearch.value.toLowerCase();
        const filtered = historyData.filter(item => item.toLowerCase().includes(searchTerm));
        renderHistoryItems(filtered);
    });

    // Update settings on change
    languageSelect.addEventListener('change', () => {
        currentLanguage = languageSelect.value;
    });
    
    interimCheckbox.addEventListener('change', () => {
        useInterim = interimCheckbox.checked;
    });
    
    continuousCheckbox.addEventListener('change', () => {
        useContinuous = continuousCheckbox.checked;
    });
    
    autoPunctuateCheckbox.addEventListener('change', () => {
        autoPunctuate = autoPunctuateCheckbox.checked;
    });
    </script>
</body>
</html>
