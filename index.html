<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 
    <title>Prompt and Speech Assistant</title>
    <style>
        /* Professional styling improvements */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: start;
            height: 100%;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        h1, h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        h1 {
            margin-top: 20px;
            font-size: 2.2rem;
            letter-spacing: -0.5px;
        }
        
        h3 {
            font-size: 1.3rem;
            color: #34495e;
        }

        button, select, input[type="checkbox"] {
            padding: 10px 20px;
            margin: 5px 5px 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button {
            background-color: #3498db;
            color: white;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        select {
            background-color: #fff;
            border: 1px solid #ddd;
            color: #333;
            padding: 9px 15px;
        }
        
        select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }

        #toggle-theme-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            background-color: #555;
            color: white;
            padding: 8px 12px;
            border-radius: 25px;
            font-size: 0.85rem;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        #quick-guide {
            margin-bottom: 20px;
            text-align: center;
        }
        
        #guide-content {
            text-align: left;
            border-left: 3px solid #3498db;
            padding-left: 15px;
        }
        
        #guide-content p {
            margin: 8px 0;
        }
        
        #guide-content kbd {
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 1px rgba(0,0,0,.2);
            color: #333;
            display: inline-block;
            font-size: 0.85rem;
            font-weight: 700;
            line-height: 1;
            padding: 3px 6px;
            white-space: nowrap;
        }

        /* Improved layout */
        #two-column-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
        }

        #left-column, #right-column {
            flex: 1;
            min-width: 300px;
            max-width: calc(50% - 12.5px);
            transition: all 0.3s ease;
        }
        
        /* Card-like designs */
        #promptContainer, #output, #timer, #settings-panel, #history-list li, .prompt-card {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        #promptContainer:hover, #output:hover {
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }
        
        /* Controls styling */
        #controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin: 0 0 15px 0;
            gap: 8px;
        }
        
        #controls button {
            flex: 1;
            min-width: 80px;
            max-width: 150px;
            padding: 10px 16px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-radius: 6px;
        }
        
        /* Button variations */
        #start-btn {
            background-color: #27ae60;
        }
        #start-btn:hover {
            background-color: #219653;
        }
        
        #stop-btn {
            background-color: #e74c3c;
        }
        #stop-btn:hover {
            background-color: #c0392b;
        }
        
        #pause-resume-btn {
            background-color: #f39c12;
        }
        #pause-resume-btn:hover {
            background-color: #d35400;
        }
        
        #tts-btn {
            background-color: #9b59b6;
        }
        #tts-btn:hover {
            background-color: #8e44ad;
        }
        
        /* Disabled state */
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        #output {
            width: 100%;
            height: 250px;
            margin-top: 15px;
            padding: 16px;
            font-size: 16px;
            line-height: 1.6;
            overflow-y: auto;
            background: white;
            transition: background-color 0.3s, color 0.3s;
            border: none;
        }

        #timer {
            font-size: 1.1rem;
            margin-top: 15px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            text-align: center;
            font-weight: 500;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        #timer::before {
            content: "‚è±";
            font-size: 1.2rem;
        }

        #status-indicator {
            display: none;
            color: #e74c3c;
            font-weight: bold;
            margin-top: 10px;
            padding: 8px 12px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 20px;
            text-align: center;
            width: fit-content;
            margin: 10px auto;
        }

        #status-indicator.active {
            display: block;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 25px;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-size: 1rem;
            font-weight: 500;
            opacity: 0;
            animation: fadeInOut 2s forwards;
            z-index: 1000;
            text-align: center;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            15% { opacity: 1; transform: translate(-50%, -50%); }
            85% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }

        #word-count {
            margin-top: 15px;
            font-size: 0.95rem;
            color: #7f8c8d;
            text-align: right;
            padding: 0 5px;
        }

        /* Prompt container styling */
        #promptContainer {
            background-color: #ffffff;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: calc(100% - 40px);
            overflow-y: auto;
            padding-bottom: 60px; /* Add extra padding at bottom for scrolling */
        }
        
        #promptContainer h2 {
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
            color: #2c3e50;
            position: relative;
            padding-bottom: 12px;
        }
        
        #promptContainer h2::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: #3498db;
            border-radius: 3px;
        }
        
        /* Favorite prompts styling */
        #prompt-categories {
            margin-bottom: 20px;
        }
        
        #category-select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .prompt-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .prompt-card {
            background-color: #f9f9f9;
            padding: 15px;
            padding-top: 40px; /* Space for the copy button */
            border-radius: 8px;
            position: relative;
            transition: all 0.2s ease;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .prompt-card:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .prompt-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1rem;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }
        
        .prompt-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .prompt-content {
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .prompt-actions {
            display: flex;
            gap: 8px;
        }
        
        .copy-btn {
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            border: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .copy-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .copy-btn:active {
            transform: translateY(0);
        }
        
        /* Academic prompts styling */
        .prompt-content {
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 15px;
            line-height: 1.5;
            max-height: 120px;
            overflow: hidden;
            position: relative;
        }
        
        .prompt-content::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: linear-gradient(transparent, #f9f9f9);
        }
        
        .dark-mode .prompt-content::after {
            background: linear-gradient(transparent, #4a5568);
        }
        
        .edit-btn {
            background-color: #f39c12;
            color: white;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .copy-btn:hover {
            opacity: 0.9;
        }
        
        /* Add new prompt form */
        #add-prompt-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        #add-prompt-form input,
        #add-prompt-form textarea,
        #add-prompt-form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        #add-prompt-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        #add-prompt-form button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        #add-prompt-form button:hover {
            background-color: #219653;
        }
        
        /* Add category section */
        #add-category-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        #add-category-form {
            display: flex;
            gap: 10px;
        }
        
        #add-category-form input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        #add-category-form button {
            background-color: #9b59b6;
            color: white;
        }

        #settings-panel, #history {
            padding: 16px;
            background: white;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        #settings-panel h3, #history h3 {
            margin-top: 0;
            margin-bottom: 16px;
            text-align: left;
            display: flex;
            align-items: center;
            font-size: 1.2rem;
        }
        
        #settings-panel h3::before {
            content: "‚öôÔ∏è";
            margin-right: 8px;
            font-size: 1.2rem;
        }
        
        #history h3::before {
            content: "üìú";
            margin-right: 8px;
            font-size: 1.2rem;
        }

        #history-list {
            list-style-type: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        #history-list li {
            margin-bottom: 10px;
            background: #f8f9fa;
            padding: 12px;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.5;
            transition: all 0.2s;
        }
        
        #history-list li:hover {
            background: #f1f1f1;
        }

        #history-list li button {
            margin: 5px 2px;
            padding: 6px 12px;
            font-size: 0.8rem;
            background-color: transparent;
            color: #3498db;
            border: 1px solid #3498db;
            box-shadow: none;
        }
        
        #history-list li button:hover {
            background-color: #3498db;
            color: white;
        }
        
        #history-list li button:last-child {
            color: #e74c3c;
            border-color: #e74c3c;
        }
        
        #history-list li button:last-child:hover {
            background-color: #e74c3c;
            color: white;
        }

        #history-search {
            width: 70%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            background-color: #f8f9fa;
            transition: all 0.3s;
        }
        
        #history-search:focus {
            outline: none;
            border-color: #3498db;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }
        
        #clear-history-btn {
            background-color: #e74c3c;
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        /* Settings styling */
        #settings-panel label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.95rem;
            cursor: pointer;
        }
        
        #settings-panel input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        #language-select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            background-color: #f8f9fa;
            margin-bottom: 15px;
            width: 100%;
            max-width: 200px;
        }

        /* Dark mode improvements */
        .dark-mode {
            background: #1a202c;
            color: #e2e8f0;
        }

        .dark-mode h1, 
        .dark-mode h3, 
        .dark-mode p, 
        .dark-mode label {
            color: #e2e8f0;
        }
        
        .dark-mode #promptContainer h2,
        .dark-mode #promptContainer label {
            color: #e2e8f0;
        }
        
        .dark-mode #promptContainer h2::after {
            background-color: #3498db;
        }

        .dark-mode #output,
        .dark-mode #promptContainer,
        .dark-mode #settings-panel,
        .dark-mode #history {
            background: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        
        .dark-mode .prompt-card {
            background-color: #4a5568;
        }
        
        .dark-mode .prompt-title {
            color: #e2e8f0;
        }
        
        .dark-mode .prompt-content {
            color: #cbd5e0;
        }
        
        .dark-mode #add-prompt-form input,
        .dark-mode #add-prompt-form textarea,
        .dark-mode #add-prompt-form select,
        .dark-mode #add-category-form input,
        .dark-mode #promptContainer select,
        .dark-mode #history-search,
        .dark-mode #language-select {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #2d3748;
        }
        
        .dark-mode #add-prompt-form input::placeholder,
        .dark-mode #add-prompt-form textarea::placeholder,
        .dark-mode #add-category-form input::placeholder,
        .dark-mode #history-search::placeholder {
            color: #a0aec0;
        }

        .dark-mode #timer {
            background: #2d3748;
            color: #e2e8f0;
        }
        
        .dark-mode #word-count {
            color: #a0aec0;
        }

        .dark-mode #history-list li {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #2d3748;
        }
        
        .dark-mode #history-list li:hover {
            background: #3a4257;
        }
        
        .dark-mode #history-list li button {
            background-color: transparent;
            color: #63b3ed;
            border-color: #63b3ed;
        }
        
        .dark-mode #history-list li button:hover {
            background-color: #4299e1;
            color: #e2e8f0;
        }
        
        .dark-mode #history-list li button:last-child {
            color: #fc8181;
            border-color: #fc8181;
        }
        
        .dark-mode #history-list li button:last-child:hover {
            background-color: #f56565;
            color: #e2e8f0;
        }
        
        .dark-mode #toggle-theme-btn {
            background-color: #718096;
        }

        .dark-mode .popup {
            background-color: rgba(255, 255, 255, 0.15);
            color: #e2e8f0;
        }
        
        .dark-mode #guide-content {
            border-left-color: #4299e1;
        }
        
        .dark-mode #guide-content kbd {
            background-color: #4a5568;
            border-color: #2d3748;
            color: #e2e8f0;
            box-shadow: 0 1px 1px rgba(0,0,0,.4);
        }
        
        /* Animation for theme transition */
        body, #output, #promptContainer, #settings-panel, #history, 
        #timer, .dark-mode #output, .dark-mode #promptContainer, 
        .dark-mode #settings-panel, .dark-mode #history, .dark-mode #timer {
            transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease;
        }
        
        /* Adjust for mobile */
        @media (max-width: 768px) {
            #left-column, #right-column {
                max-width: 100%;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            #controls button {
                font-size: 0.85rem;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Include jsPDF from CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- THEME TOGGLE BUTTON -->
    <button id="toggle-theme-btn"><i class="fas fa-moon"></i></button>

    <h1 id="main-heading">Prompt & Speech Assistant</h1>
    
    <!-- Quick guide -->
    <div id="quick-guide">
        <span id="toggle-guide" style="cursor:pointer; text-decoration:underline; color:#3498db; font-size:0.9rem;">How to use</span>
        <div id="guide-content" style="display:none; margin-top:10px; padding:15px; background:#f8f9fa; border-radius:8px; max-width:800px; font-size:0.95rem;">
            <p><strong>Left Panel:</strong> Access your favorite prompts, organize them by categories, and copy with one click.</p>
            <p><strong>Right Panel:</strong> Convert your speech to text in real-time, edit, and save the results.</p>
            <p><strong>Keyboard Shortcuts:</strong> 
                <kbd>Ctrl+B</kbd> Start/Stop Recording | 
                <kbd>Ctrl+P</kbd> Pause/Resume | 
                <kbd>Ctrl+S</kbd> Save Text
            </p>
        </div>
    </div>

    <!-- TWO-COLUMN LAYOUT -->
    <div id="two-column-layout">

        <!-- LEFT COLUMN: Favorite Prompts -->
        <div id="left-column">
            <div id="promptContainer">
                <h2>Academic Writing Prompts</h2>

                <!-- Simplified without category selector since we're focusing only on writing -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="font-style: italic; color: #666;">Copy these ready-to-use academic writing prompts with one click!</p>
                </div>

                <!-- Prompt list - will be populated by JavaScript -->
                <div class="prompt-list" id="prompt-list">
                    <!-- Prompts will be inserted here -->
                </div>
                
                <!-- Add new prompt form -->
                <div id="add-prompt-form">
                    <h3><i class="fas fa-plus-circle"></i> Add Your Own Academic Prompt</h3>
                    <input type="text" id="prompt-title" placeholder="Title (e.g. 'APA Citation Guide')" />
                    <textarea id="prompt-content" placeholder="Enter your academic writing prompt here..."></textarea>
                    <input type="hidden" id="prompt-category" value="writing" />
                    <button id="save-prompt-btn"><i class="fas fa-save"></i> Save Prompt</button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Enhanced Speech to Text Converter -->
        <div id="right-column">
            <!-- Controls with icons -->
            <div id="controls">
                <button id="start-btn"><i class="fas fa-microphone"></i> Start</button>
                <button id="stop-btn" disabled><i class="fas fa-stop"></i> Stop</button>
                <button id="pause-resume-btn"><i class="fas fa-pause"></i> Pause</button>
                <button id="save-btn"><i class="fas fa-download"></i> Save</button>
                <button id="pdf-btn"><i class="fas fa-file-pdf"></i> PDF</button>
                <button id="tts-btn"><i class="fas fa-volume-up"></i> Play</button>
            </div>

            <!-- Output area -->
            <div id="output" contenteditable="true" spellcheck="true"></div>
            <div id="timer">00:00:00</div>
            <div id="status-indicator">‚óè  Recording</div>
            <div id="word-count">Words: 0</div>

            <!-- Settings panel -->
            <div id="settings-panel">
                <h3>Settings</h3>
                <div>
                    <label for="language-select">Recognition Language:</label>
                    <select id="language-select">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="fr-FR">French (FR)</option>
                        <option value="de-DE">German (DE)</option>
                        <option value="es-ES">Spanish (ES)</option>
                        <option value="it-IT">Italian (IT)</option>
                        <option value="pt-BR">Portuguese (BR)</option>
                        <option value="zh-CN">Chinese (Simplified)</option>
                        <option value="ja-JP">Japanese (JP)</option>
                        <option value="ko-KR">Korean (KR)</option>
                        <option value="hi-IN">Hindi (IN)</option>
                        <option value="ar-SA">Arabic (SA)</option>
                    </select>
                </div>
                
                <div style="margin-top: 15px;">
                    <label><input type="checkbox" id="interim-checkbox" /> Show interim results</label>
                    <label><input type="checkbox" id="continuous-checkbox" checked/> Continuous recognition</label>
                    <label><input type="checkbox" id="auto-punctuate" checked/> Auto-punctuation</label>
                </div>
            </div>

            <!-- History -->
            <div id="history">
                <h3>Transcription History</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="history-search" placeholder="Search history..." />
                    <button id="clear-history-btn"><i class="fas fa-trash-alt"></i> Clear</button>
                </div>
                <ul id="history-list"></ul>
            </div>
        </div>
    </div>

    <!-- =============== SCRIPTS =============== -->
    <script>
    /************* STORAGE HANDLING WITH FALLBACK MECHANISM *************/
    // Create a fallback storage when localStorage isn't available
    const storageHandler = {
        // In-memory fallback storage
        memoryStorage: {
            data: {},
            getItem(key) {
                return this.data[key] || null;
            },
            setItem(key, value) {
                this.data[key] = value;
            },
            removeItem(key) {
                delete this.data[key];
            }
        },
        
        // Flag to track if localStorage is available
        hasLocalStorage: false,
        
        // Test localStorage availability
        init() {
            try {
                window.localStorage.setItem('storage_test', 'test');
                window.localStorage.removeItem('storage_test');
                this.hasLocalStorage = true;
            } catch (e) {
                this.hasLocalStorage = false;
                // Show a notification that data won't persist
                setTimeout(() => {
                    showPopup('Storage unavailable: Your prompts and settings won\'t be saved when you leave the page', 4000);
                }, 1000);
                console.log('localStorage is not available. Using in-memory storage instead.');
            }
        },
        
        // Get from storage with fallback
        getItem(key) {
            if (this.hasLocalStorage) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.log('Error accessing localStorage:', e);
                    return this.memoryStorage.getItem(key);
                }
            }
            return this.memoryStorage.getItem(key);
        },
        
        // Set to storage with fallback
        setItem(key, value) {
            if (this.hasLocalStorage) {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.log('Error writing to localStorage:', e);
                    this.memoryStorage.setItem(key, value);
                }
            } else {
                this.memoryStorage.setItem(key, value);
            }
        },
        
        // Remove from storage with fallback
        removeItem(key) {
            if (this.hasLocalStorage) {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.log('Error removing from localStorage:', e);
                    this.memoryStorage.removeItem(key);
                }
            } else {
                this.memoryStorage.removeItem(key);
            }
        }
    };
    
    // Initialize storage handler
    storageHandler.init();
    
    // Academic writing prompts (standardized to all use "academic text")
    const defaultPrompts = [
        {
            id: 'paraphrase',
            title: 'Paraphrase Text',
            content: 'Paraphrase the following academic text to avoid plagiarism while maintaining all key ideas and information. Make it sound natural and academic, but use different sentence structures and vocabulary than the original:',
            category: 'writing',
            permanent: true
        },
        {
            id: 'enhance',
            title: 'Enhance Academic Writing',
            content: 'Enhance the following academic text by improving vocabulary, sentence structure, and scholarly tone. Make it more sophisticated, precise, and academically rigorous without changing the core meaning:',
            category: 'writing',
            permanent: true
        },
        {
            id: 'grammar',
            title: 'Fix Grammar & Style',
            content: 'Correct the following academic text, fixing all grammatical errors, improving awkward phrasing, ensuring proper academic style, and maintaining consistency in tense and voice. Explain the major corrections made:',
            category: 'writing',
            permanent: true
        }
    ];
    
    // Initialize user's prompts with defaults (using storage wrapper)
    let userPrompts = JSON.parse(storageHandler.getItem('userPrompts')) || [...defaultPrompts];
    // For this version, we're focusing only on writing prompts
    let userCategories = ['writing'];
    
    // Initialize the category dropdown
    function initCategoryDropdown() {
        const categorySelect = document.getElementById('category-select');
        const promptCategorySelect = document.getElementById('prompt-category');
        
        // Clear existing options (except the "All Prompts" option for the filter dropdown)
        while (categorySelect && categorySelect.options.length > 1) {
            categorySelect.remove(1);
        }
        
        while (promptCategorySelect && promptCategorySelect.options.length > 0) {
            promptCategorySelect.remove(0);
        }
        
        // Add user categories to both dropdowns
        userCategories.forEach(category => {
            // Add to filter dropdown
            if (categorySelect) {
                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categorySelect.appendChild(filterOption);
            }
            
            // Add to new prompt form dropdown
            if (promptCategorySelect) {
                const formOption = document.createElement('option');
                formOption.value = category;
                formOption.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                promptCategorySelect.appendChild(formOption);
            }
        });
    }
    
    // Render prompts based on selected category
    function renderPrompts(category = 'all') {
        const promptList = document.getElementById('prompt-list');
        if (!promptList) return;
        
        promptList.innerHTML = '';
        
        const filteredPrompts = category === 'all' 
            ? userPrompts 
            : userPrompts.filter(prompt => prompt.category === category);
        
        if (filteredPrompts.length === 0) {
            promptList.innerHTML = '<p style="text-align:center;font-style:italic;color:#777;">No prompts in this category yet. Add one below!</p>';
            return;
        }
        
        filteredPrompts.forEach(prompt => {
            const promptCard = document.createElement('div');
            promptCard.className = 'prompt-card';
            promptCard.dataset.id = prompt.id;
            
            const titleElement = document.createElement('div');
            titleElement.className = 'prompt-title';
            titleElement.textContent = prompt.title;
            
            // Add a larger, more prominent copy button at the top right
            const quickCopyBtn = document.createElement('button');
            quickCopyBtn.className = 'copy-btn';
            quickCopyBtn.style.position = 'absolute';
            quickCopyBtn.style.top = '10px';
            quickCopyBtn.style.right = '10px';
            quickCopyBtn.style.padding = '8px 12px';
            quickCopyBtn.style.fontSize = '0.9rem';
            quickCopyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
            quickCopyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                copyPrompt(prompt.content);
            });
            
            const contentElement = document.createElement('div');
            contentElement.className = 'prompt-content';
            contentElement.textContent = prompt.content;
            
            const actionsElement = document.createElement('div');
            actionsElement.className = 'prompt-actions';
            
            promptCard.appendChild(quickCopyBtn);
            
            // Only add edit and delete buttons for non-permanent prompts
            if (!prompt.permanent) {
                const editButton = document.createElement('button');
                editButton.className = 'copy-btn edit-btn';
                editButton.innerHTML = '<i class="fas fa-edit"></i> Edit';
                editButton.addEventListener('click', () => editPrompt(prompt.id));
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'copy-btn delete-btn';
                deleteButton.innerHTML = '<i class="fas fa-trash"></i> Delete';
                deleteButton.addEventListener('click', () => deletePrompt(prompt.id));
                
                actionsElement.appendChild(editButton);
                actionsElement.appendChild(deleteButton);
            }
            
            promptCard.appendChild(titleElement);
            promptCard.appendChild(contentElement);
            promptCard.appendChild(actionsElement);
            
            promptList.appendChild(promptCard);
        });
    }
    
    // Copy prompt to clipboard
    function copyPrompt(content) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(content)
                .then(() => showPopup('Prompt copied to clipboard!'))
                .catch(err => console.error('Could not copy text: ', err));
        } else {
            // Fallback method
            const textarea = document.createElement('textarea');
            textarea.value = content;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showPopup('Prompt copied to clipboard!');
            } catch (err) {
                console.error('Could not copy text: ', err);
                showPopup('Failed to copy to clipboard.');
            }
            document.body.removeChild(textarea);
        }
    }
    
    // Edit prompt
    function editPrompt(id) {
        const prompt = userPrompts.find(p => p.id === id);
        if (!prompt) return;
        
        const titleInput = document.getElementById('prompt-title');
        const contentInput = document.getElementById('prompt-content');
        const categoryInput = document.getElementById('prompt-category');
        
        if (titleInput) titleInput.value = prompt.title;
        if (contentInput) contentInput.value = prompt.content;
        if (categoryInput) categoryInput.value = prompt.category;
        
        // Change save button to update mode
        const saveButton = document.getElementById('save-prompt-btn');
        if (saveButton) {
            saveButton.innerHTML = '<i class="fas fa-save"></i> Update Prompt';
            saveButton.dataset.editId = id;
        }
    }
    
    // Delete prompt
    function deletePrompt(id) {
        if (confirm('Are you sure you want to delete this prompt?')) {
            userPrompts = userPrompts.filter(p => p.id !== id);
            savePrompts();
            const categorySelect = document.getElementById('category-select');
            renderPrompts(categorySelect ? categorySelect.value : 'writing');
        }
    }
    
    // Save prompts to storage (using storage wrapper)
    function savePrompts() {
        storageHandler.setItem('userPrompts', JSON.stringify(userPrompts));
    }
    
    // Save categories to storage (using storage wrapper)
    function saveCategories() {
        storageHandler.setItem('userCategories', JSON.stringify(userCategories));
    }
    
    // Generate unique ID
    function generateId() {
        return 'prompt_' + Date.now() + Math.random().toString(36).substr(2, 9);
    }
    
    // Show popup message
    function showPopup(text, duration = 2000) {
        const popup = document.createElement('div');
        popup.classList.add('popup');
        popup.textContent = text;
        document.body.appendChild(popup);
        
        // For longer messages, adjust the width and add a close button
        if (text.length > 50) {
            popup.style.maxWidth = '80%';
            popup.style.padding = '15px 30px';
            
            // Add close button for longer messages
            const closeBtn = document.createElement('span');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.position = 'absolute';
            closeBtn.style.right = '10px';
            closeBtn.style.top = '5px';
            closeBtn.style.fontSize = '20px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = () => document.body.removeChild(popup);
            popup.appendChild(closeBtn);
        }
        
        setTimeout(() => {
            if (document.body.contains(popup)) {
                document.body.removeChild(popup);
            }
        }, duration);
    }
    
    /************* ENHANCED SPEECH-TO-TEXT CONVERTER LOGIC *************/
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const pauseResumeBtn = document.getElementById('pause-resume-btn');
    const saveBtn = document.getElementById('save-btn');
    const pdfBtn = document.getElementById('pdf-btn');
    const ttsBtn = document.getElementById('tts-btn');
    const output = document.getElementById('output');
    const timerDisplay = document.getElementById('timer');
    const statusIndicator = document.getElementById('status-indicator');
    const wordCountDisplay = document.getElementById('word-count');
    const historyList = document.getElementById('history-list');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const historySearch = document.getElementById('history-search');
    const toggleThemeBtn = document.getElementById('toggle-theme-btn');
    const mainHeading = document.getElementById('main-heading');

    const languageSelect = document.getElementById('language-select');
    const interimCheckbox = document.getElementById('interim-checkbox');
    const continuousCheckbox = document.getElementById('continuous-checkbox');
    const autoPunctuateCheckbox = document.getElementById('auto-punctuate');

    let timerInterval;
    let startTime;
    let speechBuffer = '';
    let isPaused = false;
    let currentLanguage = languageSelect ? languageSelect.value : 'en-US';
    let useInterim = interimCheckbox ? interimCheckbox.checked : false;
    let useContinuous = continuousCheckbox ? continuousCheckbox.checked : true;
    let autoPunctuate = autoPunctuateCheckbox ? autoPunctuateCheckbox.checked : true;
    let darkMode = false;
    
    // Function to explicitly request microphone permissions
    function requestMicrophonePermission() {
        return navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                // Stop the stream immediately, we just needed the permission
                stream.getTracks().forEach(track => track.stop());
                return true;
            })
            .catch(error => {
                console.error('Microphone permission denied:', error);
                showPopup('Microphone access denied. Please allow microphone access in your browser settings.', 5000);
                if (output) {
                    output.textContent = "‚ö†Ô∏è Microphone permission denied. Click the camera/microphone icon in your address bar and allow access, then try again.";
                }
                return false;
            });
    }
    
    function startTimer() {
        startTime = new Date();
        timerInterval = setInterval(() => {
            const elapsedTime = new Date(new Date() - startTime);
            const hours = String(elapsedTime.getUTCHours()).padStart(2, '0');
            const minutes = String(elapsedTime.getUTCMinutes()).padStart(2, '0');
            const seconds = String(elapsedTime.getUTCSeconds()).padStart(2, '0');
            if (timerDisplay) {
                timerDisplay.textContent = `${hours}:${minutes}:${seconds}`;
            }
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    function updateWordCount() {
        if (!wordCountDisplay) return;
        
        const wordCount = speechBuffer.trim().split(/\s+/).filter(word => word).length;
        wordCountDisplay.textContent = `Words: ${wordCount}`;
    }
    
    function applyAutoPunctuation(text) {
        if (!autoPunctuateCheckbox || !autoPunctuateCheckbox.checked) return text;
        
        // Basic sentence capitalization
        text = text.replace(/(?:^|[.!?]\s+)([a-z])/g, (m, p1) => {
            return m.replace(p1, p1.toUpperCase());
        });
        
        // Add periods at natural pauses if missing
        text = text.replace(/\b(okay|well|so|anyway|now|then|um|uh)\s+(?=[A-Z])/gi, (m) => {
            return m.trim() + '. ';
        });
        
        return text;
    }

    // Check browser support for Speech Recognition API
    function checkSpeechRecognitionSupport() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            showPopup("Speech Recognition is not supported in this browser. Please use Chrome, Edge, or Safari for full functionality.", 5000);
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.title = "Not supported in this browser";
            }
            if (output) {
                output.textContent = "‚ö†Ô∏è Speech Recognition is not supported in this browser. For full functionality, try Chrome, Edge, or Safari.";
            }
            return false;
        }
        return true;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = useContinuous;
        recognition.interimResults = useInterim;
        recognition.lang = currentLanguage;

        recognition.onstart = function() {
            statusIndicator.classList.add('active');
            statusIndicator.textContent = "‚óè Recording";
            
            if (!isPaused && output) {
                speechBuffer = output.textContent;
            }
            startTimer();
            
            // Add a visual indicator that microphone is active
            if (startBtn) {
                startBtn.style.backgroundColor = "#c0392b"; // Red color to indicate recording
                startBtn.innerHTML = '<i class="fas fa-microphone"></i> Recording...';
            }
        };

        recognition.onresult = function(event) {
            if (!output) return;
            
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                let transcript = event.results[i][0].transcript;
                
                // Apply auto-punctuation if enabled
                if (event.results[i].isFinal) {
                    if (autoPunctuateCheckbox && autoPunctuateCheckbox.checked) {
                        transcript = applyAutoPunctuation(transcript);
                    }
                    
                    speechBuffer += transcript + ' ';
                    output.textContent = speechBuffer;
                    updateWordCount();
                    
                    // Auto-scroll to bottom
                    output.scrollTop = output.scrollHeight;
                } else if (useInterim) {
                    let interimText = speechBuffer + transcript;
                    output.textContent = interimText;
                }
            }

            // Voice commands
            const command = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
            
            if (command === 'start' || command === 'begin recording') {
                startRecognition();
            } else if (command === 'stop' || command === 'end recording') {
                stopRecognition();
            } else if (command === 'pause') {
                pauseRecognition();
            } else if (command === 'resume') {
                resumeRecognition();
            } else if (command === 'save') {
                if (saveBtn) saveBtn.click();
            } else if (command === 'clear') {
                if (output) {
                    output.textContent = '';
                    speechBuffer = '';
                    updateWordCount();
                }
            }
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            
            let errorMessage = "";
            
            switch(event.error) {
                case 'not-allowed':
                case 'service-not-allowed':
                    errorMessage = "Microphone access denied. Please allow microphone access in your browser settings.";
                    break;
                case 'aborted':
                    errorMessage = "Speech recognition was aborted.";
                    break;
                case 'audio-capture':
                    errorMessage = "No microphone was found or microphone is not working.";
                    break;
                case 'network':
                    errorMessage = "Network error occurred. Please check your internet connection.";
                    break;
                case 'service-not-available':
                    errorMessage = "Speech recognition service is not available. Please try again later.";
                    break;
                case 'bad-grammar':
                    errorMessage = "Speech grammar error.";
                    break;
                case 'language-not-supported':
                    errorMessage = "The selected language is not supported.";
                    break;
                default:
                    errorMessage = "An error occurred with speech recognition: " + event.error;
            }
            
            // Display error message to user
            showPopup(errorMessage, 5000);
            if (output) {
                output.textContent += "\n\n‚ö†Ô∏è " + errorMessage;
            }
            
            // Reset UI
            if (statusIndicator) statusIndicator.classList.remove('active');
            if (startBtn) {
                startBtn.style.backgroundColor = "#3498db"; // Reset button color
                startBtn.innerHTML = '<i class="fas fa-microphone"></i> Start';
                startBtn.disabled = false;
            }
            if (stopBtn) stopBtn.disabled = true;
        };

        recognition.onend = function() {
            console.log("Speech recognition ended");
            
            // Reset UI elements
            if (startBtn) {
                startBtn.style.backgroundColor = "#3498db"; // Reset button color
                startBtn.innerHTML = '<i class="fas fa-microphone"></i> Start';
                startBtn.disabled = false;
            }
            
            if (stopBtn && !stopBtn.disabled && !isPaused) {
                if (useContinuous) {
                    // Try to restart recognition if it ended unexpectedly
                    console.log("Attempting to restart continuous recognition...");
                    setTimeout(() => {
                        try {
                            recognition.start();
                            if (statusIndicator) statusIndicator.textContent = "‚óè Recording (restarted)";
                        } catch (error) {
                            console.error('Failed to restart recognition:', error);
                            if (statusIndicator) statusIndicator.classList.remove('active');
                            if (stopBtn) stopBtn.disabled = true;
                        }
                    }, 1000);
                }
            } else {
                stopTimer();
                
                // Try to copy to clipboard
                if (navigator.clipboard && navigator.clipboard.writeText && output) {
                    navigator.clipboard.writeText(output.innerText)
                        .then(() => showPopup('Text copied to clipboard!'))
                        .catch(err => console.error('Could not copy text: ', err));
                }
                
                if (speechBuffer.trim()) {
                    addHistoryItem(speechBuffer.trim());
                }
                
                if (statusIndicator) statusIndicator.classList.remove('active');
            }
        };
    } else {
        // No SpeechRecognition support
        console.error('Web Speech API is not supported in this browser.');
        if (output) {
            output.textContent = "Speech Recognition is not supported in this browser. For full functionality, try Chrome, Edge, or Safari.";
        }
    }

    function startRecognition() {
        if (!recognition) {
            if (output) {
                output.textContent = "Speech Recognition is not supported in this browser. For full functionality, try Chrome, Edge, or Safari.";
            }
            return;
        }

        // Show status to user
        if (statusIndicator) {
            statusIndicator.classList.add('active');
            statusIndicator.textContent = "‚óè Requesting microphone access...";
        }
        if (output) {
            output.textContent = "Initializing speech recognition...";
        }
        
        requestMicrophonePermission().then(permissionGranted => {
            if (!permissionGranted) {
                if (statusIndicator) statusIndicator.classList.remove('active');
                return;
            }
            
            if (stopBtn) stopBtn.disabled = false;
            if (startBtn) startBtn.disabled = true;
            
            if (!isPaused && output) {
                output.textContent = '';
                speechBuffer = '';
            }
            
            // Configure recognition
            recognition.lang = currentLanguage;
            recognition.interimResults = useInterim;
            recognition.continuous = useContinuous;
            
            try {
                recognition.start();
                if (pauseResumeBtn) pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                if (statusIndicator) statusIndicator.textContent = "‚óè Recording";
            } catch (error) {
                console.error('Error starting recognition:', error);
                if (output) {
                    output.textContent = "Error starting Speech Recognition: " + error.message;
                }
                if (statusIndicator) statusIndicator.classList.remove('active');
                if (stopBtn) stopBtn.disabled = true;
                if (startBtn) startBtn.disabled = false;
            }
        });
    }

    function stopRecognition() {
        if (!recognition) return;
        
        if (stopBtn) stopBtn.disabled = true;
        if (startBtn) startBtn.disabled = false;
        isPaused = false;
        
        try {
            recognition.stop();
        } catch (error) {
            console.error('Error stopping recognition:', error);
        }
        
        if (startBtn) {
            startBtn.style.backgroundColor = "#3498db"; // Reset button color
            startBtn.innerHTML = '<i class="fas fa-microphone"></i> Start';
        }
        if (statusIndicator) statusIndicator.classList.remove('active');
    }

    function pauseRecognition() {
        if (!recognition) return;
        try {
            recognition.stop();
        } catch (error) {
            console.error('Error pausing recognition:', error);
        }
        isPaused = true;
        if (pauseResumeBtn) pauseResumeBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
        if (statusIndicator) statusIndicator.classList.remove('active');
    }

    function resumeRecognition() {
        if (!recognition) return;
        try {
            recognition.start();
        } catch (error) {
            console.error('Error resuming recognition:', error);
            showPopup("Error resuming speech recognition. Please try stopping and starting again.", 3000);
        }
        isPaused = false;
        if (pauseResumeBtn) pauseResumeBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        if (statusIndicator) {
            statusIndicator.classList.add('active');
            statusIndicator.textContent = "‚óè Recording";
        }
    }

    function copyToClipboard(text, message) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showPopup(message);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                showPopup('Failed to copy to clipboard.');
            });
        } else {
            // Fallback method
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showPopup(message);
            } catch (err) {
                console.error('Could not copy text: ', err);
                showPopup('Failed to copy to clipboard.');
            }
            document.body.removeChild(textarea);
        }
    }

    // Load history from storage (using storage wrapper)
    let historyData = JSON.parse(storageHandler.getItem('transcriptionHistory')) || [];
    renderHistoryItems(historyData);

    function addHistoryItem(text) {
        if (!text) return;
        historyData.push(text);
        storageHandler.setItem('transcriptionHistory', JSON.stringify(historyData));
        renderHistoryItems(historyData);
    }

    function renderHistoryItems(data) {
        if (!historyList) return;
        
        historyList.innerHTML = '';
        if (data.length === 0) {
            historyList.innerHTML = '<li style="text-align:center; font-style:italic; background:none; box-shadow:none;">No history items yet</li>';
            return;
        }
        
        data.forEach((item, index) => {
            const historyItem = document.createElement('li');
            historyItem.textContent = item.length > 100 ? item.substring(0, 100) + '...' : item;
            
            const copyButton = document.createElement('button');
            copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
            copyButton.addEventListener('click', () => {
                copyToClipboard(item, 'History item copied!');
            });

            const useButton = document.createElement('button');
            useButton.innerHTML = '<i class="fas fa-file-import"></i> Use';
            useButton.addEventListener('click', () => {
                if (output) {
                    output.textContent = item;
                    speechBuffer = item;
                    updateWordCount();
                    showPopup('History item loaded');
                }
            });

            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
            deleteButton.style.backgroundColor = 'transparent';
            deleteButton.addEventListener('click', () => {
                historyData.splice(index, 1);
                storageHandler.setItem('transcriptionHistory', JSON.stringify(historyData));
                renderHistoryItems(historyData);
            });

            historyItem.appendChild(document.createElement('br'));
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '5px';
            buttonContainer.style.marginTop = '8px';
            buttonContainer.appendChild(copyButton);
            buttonContainer.appendChild(useButton);
            buttonContainer.appendChild(deleteButton);
            historyItem.appendChild(buttonContainer);
            historyList.appendChild(historyItem);
        });
    }

    // Add event listeners once DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        // First check if Speech Recognition is supported
        checkSpeechRecognitionSupport();

        // Initialize prompts
        renderPrompts('writing');
        
        // Toggle quick guide
        const toggleGuideElement = document.getElementById('toggle-guide');
        if (toggleGuideElement) {
            toggleGuideElement.addEventListener('click', () => {
                const guideContent = document.getElementById('guide-content');
                if (guideContent) {
                    guideContent.style.display = guideContent.style.display === 'none' ? 'block' : 'none';
                }
            });
        }
        
        // Add event listeners for prompt functionality
        const savePromptBtn = document.getElementById('save-prompt-btn');
        if (savePromptBtn) {
            savePromptBtn.addEventListener('click', function() {
                const titleInput = document.getElementById('prompt-title');
                const contentInput = document.getElementById('prompt-content');
                const categoryInput = document.getElementById('prompt-category');
                
                if (!titleInput || !contentInput) return;
                
                const title = titleInput.value.trim();
                const content = contentInput.value.trim();
                const category = categoryInput ? categoryInput.value : 'writing';
                
                if (!title || !content) {
                    showPopup('Please fill in both title and content');
                    return;
                }
                
                // Check if we're editing or adding
                const editId = this.dataset.editId;
                
                if (editId) {
                    // Update existing prompt
                    const promptIndex = userPrompts.findIndex(p => p.id === editId);
                    if (promptIndex !== -1) {
                        userPrompts[promptIndex].title = title;
                        userPrompts[promptIndex].content = content;
                        userPrompts[promptIndex].category = category;
                    }
                    
                    // Reset button
                    this.innerHTML = '<i class="fas fa-save"></i> Save Prompt';
                    delete this.dataset.editId;
                } else {
                    // Add new prompt
                    userPrompts.push({
                        id: generateId(),
                        title,
                        content,
                        category,
                        permanent: false
                    });
                }
                
                // Save and render
                savePrompts();
                const categorySelect = document.getElementById('category-select');
                renderPrompts(categorySelect ? categorySelect.value : 'writing');
                
                // Clear form
                if (titleInput) titleInput.value = '';
                if (contentInput) contentInput.value = '';
                
                showPopup('Prompt saved successfully!');
            });
        }
        
        // Add button events for speech recognition
        if (startBtn) startBtn.addEventListener('click', startRecognition);
        if (stopBtn) stopBtn.addEventListener('click', stopRecognition);

        if (pauseResumeBtn) {
            pauseResumeBtn.addEventListener('click', () => {
                if (isPaused) {
                    resumeRecognition();
                } else {
                    pauseRecognition();
                }
            });
        }

        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                if (!output) return;
                
                const blob = new Blob([output.innerText], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'transcription.txt';
                link.click();
                showPopup('Saved as text file');
            });
        }

        if (pdfBtn) {
            pdfBtn.addEventListener('click', () => {
                if (!output) return;
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const text = output.innerText;
                    const lines = doc.splitTextToSize(text, 180);
                    doc.text(lines, 10, 10);
                    doc.save('transcription.pdf');
                    showPopup('Saved as PDF');
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    showPopup('Error generating PDF. Make sure the jsPDF library is loaded correctly.');
                }
            });
        }

        if (ttsBtn) {
            ttsBtn.addEventListener('click', () => {
                if (!output) return;
                
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(output.innerText);
                    speechSynthesis.speak(utterance);
                    showPopup('Playing audio...');
                } else {
                    showPopup('Text-to-speech is not supported in this browser.');
                }
            });
        }

        if (toggleThemeBtn) {
            toggleThemeBtn.addEventListener('click', () => {
                darkMode = !darkMode;
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    toggleThemeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    document.body.classList.remove('dark-mode');
                    toggleThemeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                }
            });
        }
        
        if (clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all history items?')) {
                    historyData = [];
                    storageHandler.setItem('transcriptionHistory', JSON.stringify(historyData));
                    renderHistoryItems(historyData);
                    showPopup('History cleared');
                }
            });
        }

        if (historySearch) {
            historySearch.addEventListener('input', () => {
                const searchTerm = historySearch.value.toLowerCase();
                const filtered = historyData.filter(item => item.toLowerCase().includes(searchTerm));
                renderHistoryItems(filtered);
            });
        }

        // Update settings on change
        if (languageSelect) {
            languageSelect.addEventListener('change', () => {
                currentLanguage = languageSelect.value;
            });
        }
        
        if (interimCheckbox) {
            interimCheckbox.addEventListener('change', () => {
                useInterim = interimCheckbox.checked;
            });
        }
        
        if (continuousCheckbox) {
            continuousCheckbox.addEventListener('change', () => {
                useContinuous = continuousCheckbox.checked;
            });
        }
        
        if (autoPunctuateCheckbox) {
            autoPunctuateCheckbox.addEventListener('change', () => {
                autoPunctuate = autoPunctuateCheckbox.checked;
            });
        }
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+B to start/stop recording
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                if (stopBtn && stopBtn.disabled) {
                    startRecognition();
                } else {
                    stopRecognition();
                }
            }
            // Ctrl+P to pause/resume
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                if (isPaused) {
                    resumeRecognition();
                } else {
                    pauseRecognition();
                }
            }
            // Ctrl+S to save text
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (saveBtn) saveBtn.click();
            }
        });
    });
    </script>
</body>
</html>
